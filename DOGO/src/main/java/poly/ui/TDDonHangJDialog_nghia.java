/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JDialog.java to edit this template
 */
package poly.ui;

import poly.controller.OrderController;
import poly.entity.Order;
import poly.entity.OrderDetail;
import poly.entity.User;
import poly.dao.impl.OrderDAOImpl;
import poly.dao.impl.UserDAOImpl;
import poly.dao.impl.ProductDAOImpl;
import poly.util.XDialog;
import poly.util.XDate;
import javax.swing.table.DefaultTableModel;
import java.util.List;
import poly.controller.OrderController_Nghia;
import poly.util.CurrentUserUtil;
import java.time.format.DateTimeFormatter;

/**
 *
 * @author Nghia
 */
public class TDDonHangJDialog_nghia extends javax.swing.JDialog implements OrderController_Nghia {

    /**
     * Creates new form TDDonHangJDialog
     */
    public TDDonHangJDialog_nghia(java.awt.Frame parent, boolean modal) {
        super(parent, modal);
        initComponents();
        // T·ª± ƒë·ªông load d·ªØ li·ªáu khi kh·ªüi t·∫°o
        open();
        // KH√îNG setEnabled cho c√°c √¥ ng√†y n·ªØa, lu√¥n cho ph√©p nh·∫≠p tay
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jLabel1 = new javax.swing.JLabel();
        jTabbedPane1 = new javax.swing.JTabbedPane();
        jPanel1 = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        tblLichSu = new javax.swing.JTable();
        btnYeuCauDoiTraLichSu = new javax.swing.JButton();
        btnXemChiTietLichSu = new javax.swing.JButton();
        cboTrangThai = new javax.swing.JComboBox();
        btnTimTrangThai = new javax.swing.JButton();
        cboThoiGian = new javax.swing.JComboBox();
        btnTimTheoThoiGian = new javax.swing.JButton();
        jLabel4 = new javax.swing.JLabel();
        txtTuNgay = new javax.swing.JTextField();
        jLabel5 = new javax.swing.JLabel();
        txtDenNgay = new javax.swing.JTextField();
        jPanel2 = new javax.swing.JPanel();
        jScrollPane2 = new javax.swing.JScrollPane();
        tblHienTai = new javax.swing.JTable();
        btnYeuCauDoiTraHienTai = new javax.swing.JButton();
        btnXemChiTietDonHienTai = new javax.swing.JButton();
        btnHuy = new javax.swing.JButton();
        cboThoiGian1 = new javax.swing.JComboBox();
        btnTimTheoThoiGian1 = new javax.swing.JButton();
        cboTrangThai1 = new javax.swing.JComboBox();
        btnTimTrangThai1 = new javax.swing.JButton();
        jLabel6 = new javax.swing.JLabel();
        txtTuNgay1 = new javax.swing.JTextField();
        jLabel7 = new javax.swing.JLabel();
        txtDenNgay1 = new javax.swing.JTextField();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);

        jLabel1.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        jLabel1.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabel1.setText("THEO D√ïI ƒê∆†N H√ÄNG");

        tblLichSu.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null}
            },
            new String [] {
                "M√£ ƒê∆°n", "Ng√†y", "Ng∆∞·ªüi ƒê·∫∑t", "Tr·∫°ng Th√°i"
            }
        ));
        tblLichSu.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                tblLichSuMouseClicked(evt);
            }
        });
        jScrollPane1.setViewportView(tblLichSu);

        btnYeuCauDoiTraLichSu.setText("Y√™u C·∫ßu ƒê·ªïi Tr·∫£");
        btnYeuCauDoiTraLichSu.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnYeuCauDoiTraLichSuActionPerformed(evt);
            }
        });

        btnXemChiTietLichSu.setText("Xem Chi Ti·∫øt");
        btnXemChiTietLichSu.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnXemChiTietLichSuActionPerformed(evt);
            }
        });

        cboTrangThai.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "T·∫•t c·∫£ tr·∫°ng th√°i", "Pending", "Processing", "Shipped", "Delivering", "Completed", "Cancelled" }));
        cboTrangThai.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cboTrangThaiActionPerformed(evt);
            }
        });

        btnTimTrangThai.setText("T√¨m ki·∫øm");
        btnTimTrangThai.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnTimTrangThaiActionPerformed(evt);
            }
        });

        cboThoiGian.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "T·∫•t c·∫£ th·ªüi gian", "H√¥m nay", "Tu·∫ßn n√†y", "Th√°ng n√†y", "3 th√°ng g·∫ßn ƒë√¢y", "T√πy ch·ªçn" }));
        cboThoiGian.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cboThoiGianActionPerformed(evt);
            }
        });

        btnTimTheoThoiGian.setText("L·ªçc theo th·ªüi gian");
        btnTimTheoThoiGian.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnTimTheoThoiGianActionPerformed(evt);
            }
        });

        jLabel4.setText("Ng√†y");

        jLabel5.setText("ƒê·∫øn");

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(91, 91, 91)
                .addComponent(btnYeuCauDoiTraLichSu)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(btnXemChiTietLichSu)
                .addGap(162, 162, 162))
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel4)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(txtTuNgay, javax.swing.GroupLayout.PREFERRED_SIZE, 129, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jLabel5)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(txtDenNgay, javax.swing.GroupLayout.PREFERRED_SIZE, 138, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(cboThoiGian, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(btnTimTheoThoiGian)
                .addGap(20, 20, 20)
                .addComponent(cboTrangThai, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(btnTimTrangThai)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane1)
                .addContainerGap())
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(17, 17, 17)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(cboTrangThai, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(btnTimTrangThai)
                    .addComponent(cboThoiGian, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(btnTimTheoThoiGian)
                    .addComponent(jLabel4)
                    .addComponent(txtTuNgay, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel5)
                    .addComponent(txtDenNgay, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(27, 27, Short.MAX_VALUE)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 219, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnYeuCauDoiTraLichSu)
                    .addComponent(btnXemChiTietLichSu))
                .addContainerGap())
        );

        jTabbedPane1.addTab("L·ªãch S·ª≠ ƒê∆°n H√†ng", jPanel1);

        tblHienTai.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null}
            },
            new String [] {
                "M√£ ƒê∆°n", "M√£ S·∫£n Ph·∫©m", "Ng√†y ƒê·∫∑t", "Ng∆∞·ªüi Nh·∫≠n", "Tr·∫°ng Th√°i"
            }
        ));
        tblHienTai.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                tblHienTaiMouseClicked(evt);
            }
        });
        jScrollPane2.setViewportView(tblHienTai);

        btnYeuCauDoiTraHienTai.setText("Y√™u C·∫ßu ƒê·ªïi Tr·∫£");
        btnYeuCauDoiTraHienTai.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnYeuCauDoiTraHienTaiActionPerformed(evt);
            }
        });

        btnXemChiTietDonHienTai.setText("Xem Chi Ti·∫øt");
        btnXemChiTietDonHienTai.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnXemChiTietDonHienTaiActionPerformed(evt);
            }
        });

        btnHuy.setText("Hu·ª∑ ƒê∆°n H√†ng");
        btnHuy.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnHuyActionPerformed(evt);
            }
        });

        cboThoiGian1.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "T·∫•t c·∫£ th·ªüi gian", "H√¥m nay", "Tu·∫ßn n√†y", "Th√°ng n√†y", "3 th√°ng g·∫ßn ƒë√¢y", "T√πy ch·ªçn" }));
        cboThoiGian1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cboThoiGian1ActionPerformed(evt);
            }
        });

        btnTimTheoThoiGian1.setText("L·ªçc theo th·ªüi gian");
        btnTimTheoThoiGian1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnTimTheoThoiGian1ActionPerformed(evt);
            }
        });

        cboTrangThai1.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "T·∫•t c·∫£ tr·∫°ng th√°i", "Pending", "Processing", "Shipped", "Delivering", "Completed", "Cancelled" }));
        cboTrangThai1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cboTrangThai1ActionPerformed(evt);
            }
        });

        btnTimTrangThai1.setText("T√¨m ki·∫øm");
        btnTimTrangThai1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnTimTrangThai1ActionPerformed(evt);
            }
        });

        jLabel6.setText("Ng√†y");

        jLabel7.setText("ƒê·∫øn");

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel2Layout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(jLabel6)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(txtTuNgay1, javax.swing.GroupLayout.PREFERRED_SIZE, 129, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jLabel7)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(txtDenNgay1, javax.swing.GroupLayout.PREFERRED_SIZE, 138, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(cboThoiGian1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(btnTimTheoThoiGian1)
                .addGap(20, 20, 20)
                .addComponent(cboTrangThai1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(btnTimTrangThai1)
                .addGap(22, 22, 22))
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addGap(96, 96, 96)
                .addComponent(btnYeuCauDoiTraHienTai)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 183, Short.MAX_VALUE)
                .addComponent(btnHuy)
                .addGap(151, 151, 151)
                .addComponent(btnXemChiTietDonHienTai)
                .addGap(102, 102, 102))
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane2)
                .addContainerGap())
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addGap(12, 12, 12)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jLabel6)
                        .addComponent(txtTuNgay1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(jLabel7)
                        .addComponent(txtDenNgay1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(cboTrangThai1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(btnTimTrangThai1)
                        .addComponent(cboThoiGian1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(btnTimTheoThoiGian1)))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 225, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(32, 32, 32)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnYeuCauDoiTraHienTai)
                    .addComponent(btnHuy)
                    .addComponent(btnXemChiTietDonHienTai))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        jTabbedPane1.addTab("ƒê∆°n H√†ng Hi·ªán T·∫°i", jPanel2);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jTabbedPane1))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel1)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(jTabbedPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 368, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(24, 24, 24))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void btnYeuCauDoiTraLichSuActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnYeuCauDoiTraLichSuActionPerformed
        requestReturn();
    }//GEN-LAST:event_btnYeuCauDoiTraLichSuActionPerformed

    private void btnXemChiTietLichSuActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnXemChiTietLichSuActionPerformed
        viewOrderDetails();
    }//GEN-LAST:event_btnXemChiTietLichSuActionPerformed

    private void tblLichSuMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_tblLichSuMouseClicked
        edit();
    }//GEN-LAST:event_tblLichSuMouseClicked

    private void tblHienTaiMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_tblHienTaiMouseClicked
        edit();
    }//GEN-LAST:event_tblHienTaiMouseClicked

    private void formWindowOpened(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_formWindowOpened
        open();
    }//GEN-LAST:event_formWindowOpened

    private void btnYeuCauDoiTraHienTaiActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnYeuCauDoiTraHienTaiActionPerformed
        requestReturn();
    }//GEN-LAST:event_btnYeuCauDoiTraHienTaiActionPerformed

    private void btnHuyActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnHuyActionPerformed
        cancelOrder();
    }//GEN-LAST:event_btnHuyActionPerformed

    private void btnXemChiTietDonHienTaiActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnXemChiTietDonHienTaiActionPerformed
        viewOrderDetails();
    }//GEN-LAST:event_btnXemChiTietDonHienTaiActionPerformed

    private void btnTimTrangThaiActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnTimTrangThaiActionPerformed
        searchByStatus();
    }//GEN-LAST:event_btnTimTrangThaiActionPerformed

    private void btnTimTheoThoiGianActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnTimTheoThoiGianActionPerformed
        searchByTime();
    }//GEN-LAST:event_btnTimTheoThoiGianActionPerformed

    private void btnTimTheoThoiGian1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnTimTheoThoiGian1ActionPerformed
        searchByTime();
    }//GEN-LAST:event_btnTimTheoThoiGian1ActionPerformed

    private void btnTimTrangThai1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnTimTrangThai1ActionPerformed
        searchByStatus();
    }//GEN-LAST:event_btnTimTrangThai1ActionPerformed

    private void cboTrangThaiActionPerformed(java.awt.event.ActionEvent evt) {
        // TODO add your handling code here:
    }                                            

    private void cboThoiGianActionPerformed(java.awt.event.ActionEvent evt) {
        String selected = (String) cboThoiGian.getSelectedItem();
        java.time.LocalDate today = java.time.LocalDate.now();
        java.time.format.DateTimeFormatter formatter = java.time.format.DateTimeFormatter.ofPattern("yyyy-MM-dd");
        if ("H√¥m nay".equals(selected)) {
            txtTuNgay.setText(today.format(formatter));
            txtDenNgay.setText(today.format(formatter));
        } else if ("Tu·∫ßn n√†y".equals(selected)) {
            java.time.LocalDate weekStart = today.with(java.time.DayOfWeek.MONDAY);
            java.time.LocalDate weekEnd = today.with(java.time.DayOfWeek.SUNDAY);
            txtTuNgay.setText(weekStart.format(formatter));
            txtDenNgay.setText(weekEnd.format(formatter));
        } else if ("Th√°ng n√†y".equals(selected)) {
            java.time.LocalDate monthStart = today.withDayOfMonth(1);
            java.time.LocalDate monthEnd = today.withDayOfMonth(today.lengthOfMonth());
            txtTuNgay.setText(monthStart.format(formatter));
            txtDenNgay.setText(monthEnd.format(formatter));
        } else if ("3 th√°ng g·∫ßn ƒë√¢y".equals(selected)) {
            java.time.LocalDate threeMonthsAgo = today.minusMonths(2).withDayOfMonth(1);
            java.time.LocalDate monthEnd = today.withDayOfMonth(today.lengthOfMonth());
            txtTuNgay.setText(threeMonthsAgo.format(formatter));
            txtDenNgay.setText(monthEnd.format(formatter));
        } else if ("T√πy ch·ªçn".equals(selected)) {
            // Kh√¥ng set g√¨ c·∫£, cho ph√©p nh·∫≠p tay
            // Kh√¥ng t·ª± ƒë·ªông c·∫≠p nh·∫≠t b·∫£ng
        } else {
            // "T·∫•t c·∫£ th·ªüi gian" ho·∫∑c gi√° tr·ªã kh√°c
            txtTuNgay.setText("");
            txtDenNgay.setText("");
        }
    }

    private void cboThoiGian1ActionPerformed(java.awt.event.ActionEvent evt) {
        String selected = (String) cboThoiGian1.getSelectedItem();
        java.time.LocalDate today = java.time.LocalDate.now();
        java.time.format.DateTimeFormatter formatter = java.time.format.DateTimeFormatter.ofPattern("yyyy-MM-dd");
        if ("H√¥m nay".equals(selected)) {
            txtTuNgay1.setText(today.format(formatter));
            txtDenNgay1.setText(today.format(formatter));
        } else if ("Tu·∫ßn n√†y".equals(selected)) {
            java.time.LocalDate weekStart = today.with(java.time.DayOfWeek.MONDAY);
            java.time.LocalDate weekEnd = today.with(java.time.DayOfWeek.SUNDAY);
            txtTuNgay1.setText(weekStart.format(formatter));
            txtDenNgay1.setText(weekEnd.format(formatter));
        } else if ("Th√°ng n√†y".equals(selected)) {
            java.time.LocalDate monthStart = today.withDayOfMonth(1);
            java.time.LocalDate monthEnd = today.withDayOfMonth(today.lengthOfMonth());
            txtTuNgay1.setText(monthStart.format(formatter));
            txtDenNgay1.setText(monthEnd.format(formatter));
        } else if ("3 th√°ng g·∫ßn ƒë√¢y".equals(selected)) {
            java.time.LocalDate threeMonthsAgo = today.minusMonths(2).withDayOfMonth(1);
            java.time.LocalDate monthEnd = today.withDayOfMonth(today.lengthOfMonth());
            txtTuNgay1.setText(threeMonthsAgo.format(formatter));
            txtDenNgay1.setText(monthEnd.format(formatter));
        } else if ("T√πy ch·ªçn".equals(selected)) {
            // Kh√¥ng set g√¨ c·∫£, cho ph√©p nh·∫≠p tay
            // Kh√¥ng t·ª± ƒë·ªông c·∫≠p nh·∫≠t b·∫£ng
        } else {
            // "T·∫•t c·∫£ th·ªüi gian" ho·∫∑c gi√° tr·ªã kh√°c
            txtTuNgay1.setText("");
            txtDenNgay1.setText("");
        }
    }

    private void cboTrangThai1ActionPerformed(java.awt.event.ActionEvent evt) {
        // TODO add your handling code here:
    }                                             

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnHuy;
    private javax.swing.JButton btnTimTheoThoiGian;
    private javax.swing.JButton btnTimTheoThoiGian1;
    private javax.swing.JButton btnTimTrangThai;
    private javax.swing.JButton btnTimTrangThai1;
    private javax.swing.JButton btnXemChiTietDonHienTai;
    private javax.swing.JButton btnXemChiTietLichSu;
    private javax.swing.JButton btnYeuCauDoiTraHienTai;
    private javax.swing.JButton btnYeuCauDoiTraLichSu;
    private javax.swing.JComboBox cboThoiGian;
    private javax.swing.JComboBox cboThoiGian1;
    private javax.swing.JComboBox cboTrangThai;
    private javax.swing.JComboBox cboTrangThai1;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JTabbedPane jTabbedPane1;
    private javax.swing.JTable tblHienTai;
    private javax.swing.JTable tblLichSu;
    private javax.swing.JTextField txtDenNgay;
    private javax.swing.JTextField txtDenNgay1;
    private javax.swing.JTextField txtTuNgay;
    private javax.swing.JTextField txtTuNgay1;
    // End of variables declaration//GEN-END:variables

    // ========== IMPLEMENTATION ==========
    private OrderDAOImpl orderDAO = new OrderDAOImpl();
    private UserDAOImpl userDAO = new UserDAOImpl();
    private ProductDAOImpl productDAO = new ProductDAOImpl();
    
    // Method ƒë·ªÉ l·∫•y th√¥ng tin ng∆∞·ªùi nh·∫≠n t·ª´ b·∫£ng Addresses
    private String getRecipientName(Integer orderId) {
        try {
            // L·∫•y th√¥ng tin ƒë∆°n h√†ng
            Order order = orderDAO.selectById(orderId);
            if (order == null || order.getDeliveryAddressId() == null) {
                return "N/A";
            }
            
            // L·∫•y th√¥ng tin ƒë·ªãa ch·ªâ giao h√†ng
            String sql = "SELECT a.AddressLine1, a.City, a.Country, a.Phone, u.FullName " +
                        "FROM Addresses a " +
                        "LEFT JOIN Users u ON a.UserID = u.UserID " +
                        "WHERE a.AddressID = ?";
            
            java.sql.ResultSet rs = poly.util.XJdbc.executeQuery(sql, order.getDeliveryAddressId());
            if (rs.next()) {
                String fullName = rs.getString("FullName");
                String phone = rs.getString("Phone");
                
                // ∆Øu ti√™n hi·ªÉn th·ªã t√™n ng∆∞·ªùi nh·∫≠n t·ª´ ƒë·ªãa ch·ªâ giao h√†ng
                // Th√¥ng tin n√†y ƒë∆∞·ª£c l∆∞u t·ª´ form "X√°c nh·∫≠n ƒë∆°n h√†ng"
                if (fullName != null && !fullName.trim().isEmpty()) {
                    return fullName;
                } else if (phone != null && !phone.trim().isEmpty()) {
                    return "Ng∆∞·ªùi nh·∫≠n: " + phone;
                } else {
                    return "N/A";
                }
            }
        } catch (Exception e) {
            System.err.println("L·ªói l·∫•y th√¥ng tin ng∆∞·ªùi nh·∫≠n: " + e.getMessage());
        }
        return "N/A";
    }
    
    // Method ƒë·ªÉ l·∫•y th√¥ng tin ƒë·ªãa ch·ªâ giao h√†ng
    // Th√¥ng tin n√†y ƒë∆∞·ª£c l∆∞u t·ª´ form "X√°c nh·∫≠n ƒë∆°n h√†ng" trong DatHangJDialog
    private String getRecipientAddress(Integer orderId) {
        try {
            // L·∫•y th√¥ng tin ƒë∆°n h√†ng
            Order order = orderDAO.selectById(orderId);
            if (order == null || order.getDeliveryAddressId() == null) {
                return "N/A";
            }
            
            // L·∫•y th√¥ng tin ƒë·ªãa ch·ªâ giao h√†ng t·ª´ b·∫£ng Addresses
            // Th√¥ng tin n√†y ƒë∆∞·ª£c t·∫°o t·ª´ form ƒë·∫∑t h√†ng c·ªßa ng∆∞·ªùi d√πng
            String sql = "SELECT a.AddressLine1, a.City, a.Country, a.Phone " +
                        "FROM Addresses a " +
                        "WHERE a.AddressID = ?";
            
            java.sql.ResultSet rs = poly.util.XJdbc.executeQuery(sql, order.getDeliveryAddressId());
            if (rs.next()) {
                String addressLine1 = rs.getString("AddressLine1");
                String city = rs.getString("City");
                String country = rs.getString("Country");
                String phone = rs.getString("Phone");
                
                StringBuilder address = new StringBuilder();
                if (addressLine1 != null && !addressLine1.trim().isEmpty()) {
                    address.append(addressLine1);
                }
                if (city != null && !city.trim().isEmpty()) {
                    if (address.length() > 0) address.append(", ");
                    address.append(city);
                }
                if (country != null && !country.trim().isEmpty()) {
                    if (address.length() > 0) address.append(", ");
                    address.append(country);
                }
                
                String result = address.toString();
                if (result.isEmpty()) {
                    return "N/A";
                }
                
                // Th√™m s·ªë ƒëi·ªán tho·∫°i n·∫øu c√≥
                if (phone != null && !phone.trim().isEmpty()) {
                    result += " (SƒêT: " + phone + ")";
                }
                
                return result;
            }
        } catch (Exception e) {
            System.err.println("L·ªói l·∫•y th√¥ng tin ƒë·ªãa ch·ªâ: " + e.getMessage());
        }
        return "N/A";
    }
    private Order currentOrder = null;
    private boolean isProcessingOrder = false; // Flag ƒë·ªÉ tr√°nh x·ª≠ l√Ω nhi·ªÅu l·∫ßn

    @Override
    public void open() {
        fillToTable();
        setLocationRelativeTo(null);
        
        // Kh·ªüi t·∫°o tr·∫°ng th√°i c√°c n√∫t
        btnHuy.setEnabled(false);
        btnYeuCauDoiTraLichSu.setEnabled(false);
        btnYeuCauDoiTraHienTai.setEnabled(false);
    }

    @Override
    public void setForm(Order entity) {
        // Kh√¥ng c·∫ßn form cho m√†n h√¨nh theo d√µi
    }

    @Override
    public Order getForm() {
        return currentOrder;
    }

    @Override
    public void fillToTable() {
        DefaultTableModel model = (DefaultTableModel) tblLichSu.getModel();
        model.setRowCount(0);
        Integer currentUserId = CurrentUserUtil.getCurrentUserId();
        if (currentUserId == null) {
            XDialog.alert("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ng∆∞·ªùi d√πng hi·ªán t·∫°i!");
            return;
        }
        try {
            List<Order> list = orderDAO.selectByUserId(currentUserId);
            for (Order order : list) {
                String recipientName = getRecipientName(order.getOrderId());
                model.addRow(new Object[]{
                    order.getOrderId(),
                    order.getOrderDate() != null ? order.getOrderDate().toString() : "N/A",
                    recipientName,
                    getStatusDisplayName(order.getOrderStatus())
                });
            }
        } catch (Exception e) {
            XDialog.alert("L·ªói t·∫£i d·ªØ li·ªáu: " + e.getMessage());
        }
        fillCurrentOrdersTable();
    }

    private void fillCurrentOrdersTable() {
        DefaultTableModel model = (DefaultTableModel) tblHienTai.getModel();
        model.setRowCount(0);
        Integer currentUserId = CurrentUserUtil.getCurrentUserId();
        if (currentUserId == null) {
            XDialog.alert("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ng∆∞·ªùi d√πng hi·ªán t·∫°i!");
            return;
        }
        try {
            // L·∫•y ƒë∆°n h√†ng c√≥ th·ªÉ thao t√°c c·ªßa user hi·ªán t·∫°i
            List<Order> list = new java.util.ArrayList<>();
            list.addAll(orderDAO.selectByUserId(currentUserId).stream().filter(o -> "Pending".equals(o.getOrderStatus())).toList());
            list.addAll(orderDAO.selectByUserId(currentUserId).stream().filter(o -> "Processing".equals(o.getOrderStatus())).toList());
            list.addAll(orderDAO.selectByUserId(currentUserId).stream().filter(o -> "Shipped".equals(o.getOrderStatus())).toList());
            list.addAll(orderDAO.selectByUserId(currentUserId).stream().filter(o -> "Delivering".equals(o.getOrderStatus())).toList());
            list.addAll(orderDAO.selectByUserId(currentUserId).stream().filter(o -> "Completed".equals(o.getOrderStatus())).toList());
            for (Order order : list) {
                String recipientName = getRecipientName(order.getOrderId());
                model.addRow(new Object[]{
                    order.getOrderId(),
                    getProductNames(order.getOrderId()),
                    order.getOrderDate() != null ? order.getOrderDate().toString() : "N/A",
                    recipientName,
                    getStatusDisplayName(order.getOrderStatus())
                });
            }
        } catch (Exception e) {
            XDialog.alert("L·ªói t·∫£i d·ªØ li·ªáu: " + e.getMessage());
        }
    }

    private String getProductNames(Integer orderId) {
        try {
            List<OrderDetail> details = orderDAO.getOrderDetails(orderId);
            if (details.isEmpty()) return "N/A";
            
            StringBuilder sb = new StringBuilder();
            for (int i = 0; i < Math.min(details.size(), 2); i++) {
                OrderDetail detail = details.get(i);
                if (i > 0) sb.append(", ");
                sb.append(detail.getProductId());
            }
            if (details.size() > 2) sb.append("...");
            return sb.toString();
        } catch (Exception e) {
            return "N/A";
        }
    }

    @Override
    public void edit() {
        int selectedTab = jTabbedPane1.getSelectedIndex();
        int row = selectedTab == 0 ? tblLichSu.getSelectedRow() : tblHienTai.getSelectedRow();
        
        if (row >= 0) {
            Integer orderId = (Integer) (selectedTab == 0 ? 
                tblLichSu.getValueAt(row, 0) : tblHienTai.getValueAt(row, 0));
            currentOrder = orderDAO.selectById(orderId);
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i c√°c n√∫t d·ª±a tr√™n tr·∫°ng th√°i ƒë∆°n h√†ng
            if (currentOrder != null) {
                String status = currentOrder.getOrderStatus();
                
                // Enable/disable n√∫t hu·ª∑ ƒë∆°n h√†ng
                btnHuy.setEnabled(canCancelOrder(status));
                
                // Enable/disable n√∫t y√™u c·∫ßu ƒë·ªïi tr·∫£
                btnYeuCauDoiTraLichSu.setEnabled(canRequestReturn(status));
                btnYeuCauDoiTraHienTai.setEnabled(canRequestReturn(status));
            }
        }
    }

    @Override
    public void create() {
        // Kh√¥ng c·∫ßn t·∫°o m·ªõi trong m√†n h√¨nh theo d√µi
    }

    @Override
    public void update() {
        // Kh√¥ng c·∫ßn c·∫≠p nh·∫≠t trong m√†n h√¨nh theo d√µi
    }

    @Override
    public void delete() {
        // Kh√¥ng c·∫ßn x√≥a trong m√†n h√¨nh theo d√µi
    }

    @Override
    public void clear() {
        // Kh√¥ng c·∫ßn clear trong m√†n h√¨nh theo d√µi
    }

    @Override
    public void setEditable(boolean editable) {
        // Kh√¥ng c·∫ßn set editable trong m√†n h√¨nh theo d√µi
    }

    @Override
    public void checkAll() {
        // Kh√¥ng c·∫ßn check all trong m√†n h√¨nh theo d√µi
    }

    @Override
    public void uncheckAll() {
        // Kh√¥ng c·∫ßn uncheck all trong m√†n h√¨nh theo d√µi
    }

    @Override
    public void deleteCheckedItems() {
        // Kh√¥ng c·∫ßn delete checked items trong m√†n h√¨nh theo d√µi
    }

    @Override
    public void moveFirst() {
        // Kh√¥ng c·∫ßn move first trong m√†n h√¨nh theo d√µi
    }

    @Override
    public void movePrevious() {
        // Kh√¥ng c·∫ßn move previous trong m√†n h√¨nh theo d√µi
    }

    @Override
    public void moveNext() {
        // Kh√¥ng c·∫ßn move next trong m√†n h√¨nh theo d√µi
    }

    @Override
    public void moveLast() {
        // Kh√¥ng c·∫ßn move last trong m√†n h√¨nh theo d√µi
    }

    @Override
    public void moveTo(int rowIndex) {
        // Kh√¥ng c·∫ßn move to trong m√†n h√¨nh theo d√µi
    }

    // ========== BUSINESS LOGIC ==========
    private void searchByStatus() {
        int selectedTab = jTabbedPane1.getSelectedIndex();
        String status = selectedTab == 0 ? 
            (String) cboTrangThai.getSelectedItem() : (String) cboTrangThai1.getSelectedItem();
        Integer currentUserId = CurrentUserUtil.getCurrentUserId();
        if (currentUserId == null) {
            XDialog.alert("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ng∆∞·ªùi d√πng hi·ªán t·∫°i!");
            return;
        }
        if ("T·∫•t c·∫£ tr·∫°ng th√°i".equals(status)) {
            fillToTable();
            return;
        }
        DefaultTableModel model = (DefaultTableModel) (selectedTab == 0 ? 
            tblLichSu.getModel() : tblHienTai.getModel());
        model.setRowCount(0);
        try {
            List<Order> list = orderDAO.selectByUserId(currentUserId).stream().filter(o -> status.equals(o.getOrderStatus())).toList();
            for (Order order : list) {
                String recipientName = getRecipientName(order.getOrderId());
                if (selectedTab == 0) {
                    model.addRow(new Object[]{
                        order.getOrderId(),
                        order.getOrderDate() != null ? order.getOrderDate().toString() : "N/A",
                        recipientName,
                        getStatusDisplayName(order.getOrderStatus())
                    });
                } else {
                    model.addRow(new Object[]{
                        order.getOrderId(),
                        getProductNames(order.getOrderId()),
                        order.getOrderDate() != null ? order.getOrderDate().toString() : "N/A",
                        recipientName,
                        getStatusDisplayName(order.getOrderStatus())
                    });
                }
            }
        } catch (Exception e) {
            XDialog.alert("L·ªói t√¨m ki·∫øm: " + e.getMessage());
        }
    }

    private void searchByTime() {
        int selectedTab = jTabbedPane1.getSelectedIndex();
        String timeFilter = selectedTab == 0 ? 
            (String) cboThoiGian.getSelectedItem() : (String) cboThoiGian1.getSelectedItem();
        Integer currentUserId = CurrentUserUtil.getCurrentUserId();
        if (currentUserId == null) {
            XDialog.alert("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ng∆∞·ªùi d√πng hi·ªán t·∫°i!");
            return;
        }
        if ("T·∫•t c·∫£ th·ªùi gian".equals(timeFilter) || "T·∫•t c·∫£ th·ªüi gian".equals(timeFilter)) {
            fillToTable();
            return;
        }
        DefaultTableModel model = (DefaultTableModel) (selectedTab == 0 ? 
            tblLichSu.getModel() : tblHienTai.getModel());
        model.setRowCount(0);
        try {
            List<Order> list = orderDAO.selectByUserId(currentUserId); // L·∫•y ƒë∆°n h√†ng c·ªßa user hi·ªán t·∫°i
            List<Order> filteredList;
            if ("T√πy ch·ªçn".equals(timeFilter)) {
                // L·∫•y ng√†y t·ª´ c√°c tr∆∞·ªùng nh·∫≠p
                String tuNgayStr = selectedTab == 0 ? txtTuNgay.getText().trim() : txtTuNgay1.getText().trim();
                String denNgayStr = selectedTab == 0 ? txtDenNgay.getText().trim() : txtDenNgay1.getText().trim();
                if (tuNgayStr.isEmpty() || denNgayStr.isEmpty()) {
                    XDialog.alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c!");
                    return;
                }
                java.time.format.DateTimeFormatter formatter = java.time.format.DateTimeFormatter.ofPattern("yyyy-MM-dd");
                java.time.LocalDate tuNgay, denNgay;
                try {
                    tuNgay = java.time.LocalDate.parse(tuNgayStr, formatter);
                    denNgay = java.time.LocalDate.parse(denNgayStr, formatter);
                } catch (Exception e) {
                    XDialog.alert("ƒê·ªãnh d·∫°ng ng√†y kh√¥ng h·ª£p l·ªá! ƒê·ªãnh d·∫°ng ƒë√∫ng: yyyy-MM-dd");
                    return;
                }
                // Ki·ªÉm tra h·ª£p l·ªá: ng√†y b·∫Øt ƒë·∫ßu ph·∫£i <= ng√†y k·∫øt th√∫c
                if (tuNgay.isAfter(denNgay)) {
                    XDialog.alert("Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n ng√†y k·∫øt th√∫c!");
                    return;
                }
                filteredList = new java.util.ArrayList<>();
                for (Order order : list) {
                    if (order.getOrderDate() == null) continue;
                    java.time.LocalDate orderDate = order.getOrderDate().toLocalDate();
                    // S·ª≠a logic: bao g·ªìm c·∫£ ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c
                    if (!orderDate.isBefore(tuNgay) && !orderDate.isAfter(denNgay)) {
                        filteredList.add(order);
                    }
                }
            } else {
                filteredList = filterOrdersByTime(list, timeFilter);
            }
            for (Order order : filteredList) {
                String recipientName = getRecipientName(order.getOrderId());
                if (selectedTab == 0) {
                    model.addRow(new Object[]{
                        order.getOrderId(),
                        order.getOrderDate() != null ? order.getOrderDate().toString() : "N/A",
                        recipientName,
                        getStatusDisplayName(order.getOrderStatus())
                    });
                } else {
                    model.addRow(new Object[]{
                        order.getOrderId(),
                        getProductNames(order.getOrderId()),
                        order.getOrderDate() != null ? order.getOrderDate().toString() : "N/A",
                        recipientName,
                        getStatusDisplayName(order.getOrderStatus())
                    });
                }
            }
        } catch (Exception e) {
            XDialog.alert("L·ªói t√¨m ki·∫øm: " + e.getMessage());
        }
    }

    private List<Order> filterOrdersByTime(List<Order> orders, String timeFilter) {
        List<Order> filtered = new java.util.ArrayList<>();
        java.time.LocalDate today = java.time.LocalDate.now();
        
        for (Order order : orders) {
            if (order.getOrderDate() == null) continue;
            
            java.time.LocalDate orderDate = order.getOrderDate().toLocalDate();
            boolean include = false;
            
            switch (timeFilter) {
                case "H√¥m nay":
                    include = orderDate.equals(today);
                    break;
                case "Tu·∫ßn n√†y":
                    java.time.LocalDate weekStart = today.with(java.time.DayOfWeek.MONDAY);
                    java.time.LocalDate weekEnd = today.with(java.time.DayOfWeek.SUNDAY);
                    include = !orderDate.isBefore(weekStart) && !orderDate.isAfter(weekEnd);
                    break;
                case "Th√°ng n√†y":
                    include = orderDate.getYear() == today.getYear() && 
                             orderDate.getMonth() == today.getMonth();
                    break;
                case "3 th√°ng g·∫ßn ƒë√¢y":
                    java.time.LocalDate threeMonthsAgo = today.minusMonths(3);
                    include = !orderDate.isBefore(threeMonthsAgo) && !orderDate.isAfter(today);
                    break;
                default:
                    include = true;
            }
            
            if (include) {
                filtered.add(order);
            }
        }
        
        return filtered;
    }

    private void viewOrderDetails() {
        edit();
        if (currentOrder == null) {
            XDialog.alert("Vui l√≤ng ch·ªçn ƒë∆°n h√†ng ƒë·ªÉ xem chi ti·∫øt!");
            return;
        }
        
        try {
            List<OrderDetail> details = orderDAO.getOrderDetails(currentOrder.getOrderId());
            User user = userDAO.selectById(currentOrder.getUserId());
            String recipientName = getRecipientName(currentOrder.getOrderId());
            String recipientAddress = getRecipientAddress(currentOrder.getOrderId());
            
            StringBuilder sb = new StringBuilder();
            sb.append("=== CHI TI·∫æT ƒê∆†N H√ÄNG ===\n");
            sb.append("M√£ ƒë∆°n: ").append(currentOrder.getOrderId()).append("\n");
            sb.append("Ng√†y ƒë·∫∑t: ").append(currentOrder.getOrderDate() != null ? currentOrder.getOrderDate().toString() : "N/A").append("\n");
            sb.append("Ng∆∞·ªùi ƒë·∫∑t: ").append(user != null ? user.getFullName() : "N/A").append("\n");
            sb.append("Ng∆∞·ªùi nh·∫≠n: ").append(recipientName).append("\n");
            sb.append("ƒê·ªãa ch·ªâ giao h√†ng: ").append(recipientAddress).append("\n");
            sb.append("S·ªë ƒëi·ªán tho·∫°i: ").append(user != null ? user.getPhone() : "N/A").append("\n");
            sb.append("T·ªïng ti·ªÅn: ").append(String.format("$%,.2f", currentOrder.getTotalAmount())).append("\n");
            sb.append("T·ªïng s·ªë ti·ªÅn ph·∫£i tr·∫£: ").append(String.format("$%,.2f", currentOrder.getTotalAmount())).append("\n");
            sb.append("Tr·∫°ng th√°i: ").append(getStatusDisplayName(currentOrder.getOrderStatus())).append("\n");
            
            // Hi·ªÉn th·ªã th√¥ng tin b·ªï sung cho tr·∫°ng th√°i Cancelled
            if ("Cancelled".equals(currentOrder.getOrderStatus()) && currentOrder.getReturnReason() != null) {
                String reason = currentOrder.getReturnReason();
                if (reason.startsWith("[ƒê·ªîI TR·∫¢")) {
                    sb.append("üìã Lo·∫°i: Y√™u c·∫ßu ƒë·ªïi tr·∫£\n");
                } else if (reason.startsWith("[HU·ª∂]")) {
                    sb.append("üìã Lo·∫°i: Hu·ª∑ ƒë∆°n h√†ng\n");
                }
            }
            sb.append("Ph∆∞∆°ng th·ª©c thanh to√°n: ").append(currentOrder.getPaymentMethod() != null ? currentOrder.getPaymentMethod() : "N/A").append("\n");
            
            // Hi·ªÉn th·ªã l√Ω do ƒë·ªïi tr·∫£ ho·∫∑c l√Ω do hu·ª∑ ƒë∆°n h√†ng n·∫øu c√≥
            if (currentOrder.getReturnReason() != null && !currentOrder.getReturnReason().trim().isEmpty()) {
                String reason = currentOrder.getReturnReason();
                
                // Ph√¢n bi·ªát r√µ r√†ng lo·∫°i l√Ω do
                if (reason.startsWith("[ƒê·ªîI TR·∫¢ - ƒê√É THANH TO√ÅN]")) {
                    sb.append("üîÑ Y√äU C·∫¶U ƒê·ªîI TR·∫¢ (ƒê√£ thanh to√°n):\n");
                    sb.append("   ‚Üí L√Ω do: ").append(reason.substring(25)).append("\n");
                    sb.append("   ‚Üí X·ª≠ l√Ω: Ho√†n ti·ªÅn + Tr·∫£ h√†ng\n\n");
                } else if (reason.startsWith("[ƒê·ªîI TR·∫¢ - CH∆ØA THANH TO√ÅN]")) {
                    sb.append("üîÑ Y√äU C·∫¶U ƒê·ªîI TR·∫¢ (Ch∆∞a thanh to√°n):\n");
                    sb.append("   ‚Üí L√Ω do: ").append(reason.substring(28)).append("\n");
                    sb.append("   ‚Üí X·ª≠ l√Ω: Ch·ªâ tr·∫£ h√†ng\n\n");
                } else if (reason.startsWith("[ƒê·ªîI TR·∫¢]")) {
                    sb.append("üîÑ Y√äU C·∫¶U ƒê·ªîI TR·∫¢:\n");
                    sb.append("   ‚Üí L√Ω do: ").append(reason.substring(10)).append("\n\n");
                } else if (reason.startsWith("[HU·ª∂]")) {
                    sb.append("‚ùå L√ù DO HU·ª∂ ƒê∆†N H√ÄNG:\n");
                    sb.append("   ‚Üí L√Ω do: ").append(reason.substring(6)).append("\n");
                    sb.append("   ‚Üí X·ª≠ l√Ω: Hu·ª∑ ƒë∆°n h√†ng + C·∫≠p nh·∫≠t t·ªìn kho\n\n");
                } else {
                    // Fallback cho d·ªØ li·ªáu c≈©
                    sb.append("üìù L√ù DO:\n");
                    sb.append("   ‚Üí ").append(reason).append("\n\n");
                }
            }
            
            sb.append("\n");
            
            sb.append("=== DANH S√ÅCH S·∫¢N PH·∫®M ===\n");
            for (OrderDetail detail : details) {
                // L·∫•y th√¥ng tin s·∫£n ph·∫©m ƒë·ªÉ hi·ªÉn th·ªã t√™n thay v√¨ m√£
                String productName = "N/A";
                try {
                    poly.entity.Product product = productDAO.selectById(detail.getProductId());
                    if (product != null) {
                        productName = product.getProductName();
                    }
                } catch (Exception e) {
                    // N·∫øu kh√¥ng l·∫•y ƒë∆∞·ª£c t√™n s·∫£n ph·∫©m th√¨ d√πng m√£
                    productName = detail.getProductId();
                }
                
                sb.append("‚Ä¢ ").append(productName)
                  .append(" - S·ªë l∆∞·ª£ng: ").append(detail.getQuantity())
                  .append(" - ƒê∆°n gi√°: ").append(String.format("$%,.2f", detail.getUnitPrice()))
                  .append(" - Th√†nh ti·ªÅn: ").append(String.format("$%,.2f", detail.getUnitPrice().multiply(new java.math.BigDecimal(detail.getQuantity()))))
                  .append("\n");
            }
            
            XDialog.alert(sb.toString());
        } catch (Exception e) {
            XDialog.alert("L·ªói xem chi ti·∫øt: " + e.getMessage());
        }
    }

    private void requestReturn() {
        if (isProcessingOrder) {
            return; // Tr√°nh x·ª≠ l√Ω nhi·ªÅu l·∫ßn
        }
        
        edit();
        if (currentOrder == null) {
            XDialog.alert("Vui l√≤ng ch·ªçn ƒë∆°n h√†ng ƒë·ªÉ y√™u c·∫ßu ƒë·ªïi tr·∫£!");
            return;
        }
        
        // Cho ph√©p y√™u c·∫ßu ƒë·ªïi tr·∫£ khi ƒë√£ nh·∫≠n h√†ng (Completed) ho·∫∑c ƒëang giao h√†ng (Delivering)
        if (!"Completed".equals(currentOrder.getOrderStatus()) && !"Delivering".equals(currentOrder.getOrderStatus())) {
            XDialog.alert("Ch·ªâ c√≥ th·ªÉ y√™u c·∫ßu ƒë·ªïi tr·∫£ ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh ho·∫∑c ƒëang giao h√†ng!");
            return;
        }
        
        // Hi·ªÉn th·ªã dialog nh·∫≠p l√Ω do ƒë·ªïi tr·∫£
        String returnReason = javax.swing.JOptionPane.showInputDialog(
            this,
            "Vui l√≤ng nh·∫≠p l√Ω do ƒë·ªïi tr·∫£:",
            "Y√™u c·∫ßu ƒë·ªïi tr·∫£",
            javax.swing.JOptionPane.QUESTION_MESSAGE
        );
        
        if (returnReason != null && !returnReason.trim().isEmpty()) {
            if (XDialog.confirm("B·∫°n c√≥ ch·∫Øc mu·ªën y√™u c·∫ßu ƒë·ªïi tr·∫£ ƒë∆°n h√†ng n√†y?")) {
                try {
                    isProcessingOrder = true; // Set flag
                    
                    // Ph√¢n bi·ªát lo·∫°i ƒë·ªïi tr·∫£ d·ª±a tr√™n tr·∫°ng th√°i
                    String reasonWithPrefix;
                    if ("Completed".equals(currentOrder.getOrderStatus())) {
                        reasonWithPrefix = "[ƒê·ªîI TR·∫¢ - ƒê√É THANH TO√ÅN] " + returnReason.trim();
                    } else {
                        reasonWithPrefix = "[ƒê·ªîI TR·∫¢ - CH∆ØA THANH TO√ÅN] " + returnReason.trim();
                    }
                    
                    orderDAO.updateOrderStatusWithReasonAndInventory(currentOrder.getOrderId(), "Cancelled", reasonWithPrefix);
                    XDialog.alert("ƒê√£ g·ª≠i y√™u c·∫ßu ƒë·ªïi tr·∫£ th√†nh c√¥ng v√† c·∫≠p nh·∫≠t t·ªìn kho!");
                    fillToTable();
                } catch (Exception e) {
                    XDialog.alert("L·ªói g·ª≠i y√™u c·∫ßu: " + e.getMessage());
                } finally {
                    isProcessingOrder = false; // Reset flag
                }
            }
        } else if (returnReason != null) {
            XDialog.alert("Vui l√≤ng nh·∫≠p l√Ω do ƒë·ªïi tr·∫£!");
        }
    }

    private String getStatusDisplayName(String status) {
        switch (status) {
            case "Pending": return "‚è≥ Ch·ªù x·ª≠ l√Ω";
            case "Processing": return "‚öôÔ∏è ƒêang x·ª≠ l√Ω";
            case "Shipped": return "üì¶ ƒê√£ g·ª≠i h√†ng";
            case "Delivering": return "üöö ƒêang giao h√†ng";
            case "Completed": return "‚úÖ ƒê√£ ho√†n th√†nh";
            case "Cancelled": return "‚ùå ƒê√£ hu·ª∑/ƒê·ªïi tr·∫£";
            default: return status;
        }
    }
    
    private boolean canCancelOrder(String status) {
        return "Pending".equals(status) || "Processing".equals(status) || "Shipped".equals(status) || "Delivering".equals(status);
    }
    
    private boolean canRequestReturn(String status) {
        return "Completed".equals(status) || "Delivering".equals(status);
    }

    private void cancelOrder() {
        if (isProcessingOrder) {
            return; // Tr√°nh x·ª≠ l√Ω nhi·ªÅu l·∫ßn
        }
        
        edit();
        if (currentOrder == null) {
            XDialog.alert("Vui l√≤ng ch·ªçn ƒë∆°n h√†ng ƒë·ªÉ hu·ª∑!");
            return;
        }
        
        // Cho ph√©p hu·ª∑ khi ch∆∞a ho√†n th√†nh (Pending, Processing, Shipped, Delivering)
        if (!"Pending".equals(currentOrder.getOrderStatus()) && !"Processing".equals(currentOrder.getOrderStatus()) && !"Shipped".equals(currentOrder.getOrderStatus()) && !"Delivering".equals(currentOrder.getOrderStatus())) {
            XDialog.alert("Ch·ªâ c√≥ th·ªÉ hu·ª∑ ƒë∆°n h√†ng khi ch∆∞a ho√†n th√†nh (ƒëang ch·ªù x·ª≠ l√Ω, ƒëang x·ª≠ l√Ω, ƒë√£ g·ª≠i h√†ng ho·∫∑c ƒëang giao h√†ng)!");
            return;
        }
        
        // Hi·ªÉn th·ªã dialog nh·∫≠p l√Ω do hu·ª∑ ƒë∆°n h√†ng
        String cancelReason = javax.swing.JOptionPane.showInputDialog(
            this,
            "Vui l√≤ng nh·∫≠p l√Ω do hu·ª∑ ƒë∆°n h√†ng:",
            "Hu·ª∑ ƒë∆°n h√†ng",
            javax.swing.JOptionPane.QUESTION_MESSAGE
        );
        
        if (cancelReason != null && !cancelReason.trim().isEmpty()) {
            if (XDialog.confirm("B·∫°n c√≥ ch·∫Øc mu·ªën hu·ª∑ ƒë∆°n h√†ng n√†y?")) {
                try {
                    isProcessingOrder = true; // Set flag
                    
                    // S·ª≠ d·ª•ng method m·ªõi ƒë·ªÉ l∆∞u c·∫£ tr·∫°ng th√°i, l√Ω do v√† c·∫≠p nh·∫≠t t·ªìn kho
                    // Th√™m prefix ƒë·ªÉ admin ph√¢n bi·ªát ƒë∆∞·ª£c
                    String reasonWithPrefix = "[HU·ª∂] " + cancelReason.trim();
                    orderDAO.updateOrderStatusWithReasonAndInventory(currentOrder.getOrderId(), "Cancelled", reasonWithPrefix);
                    XDialog.alert("ƒê√£ hu·ª∑ ƒë∆°n h√†ng th√†nh c√¥ng v√† c·∫≠p nh·∫≠t t·ªìn kho!");
                    fillToTable();
                } catch (Exception e) {
                    XDialog.alert("L·ªói hu·ª∑ ƒë∆°n h√†ng: " + e.getMessage());
                } finally {
                    isProcessingOrder = false; // Reset flag
                }
            }
        } else if (cancelReason != null) {
            XDialog.alert("Vui l√≤ng nh·∫≠p l√Ω do hu·ª∑ ƒë∆°n h√†ng!");
        }
    }

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException ex) {
            java.util.logging.Logger.getLogger(TDDonHangJDialog_nghia.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (InstantiationException ex) {
            java.util.logging.Logger.getLogger(TDDonHangJDialog_nghia.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (IllegalAccessException ex) {
            java.util.logging.Logger.getLogger(TDDonHangJDialog_nghia.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(TDDonHangJDialog_nghia.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>
        //</editor-fold>

        /* Create and display the dialog */
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                TDDonHangJDialog_nghia dialog = new TDDonHangJDialog_nghia(new javax.swing.JFrame(), true);
                dialog.addWindowListener(new java.awt.event.WindowAdapter() {
                    @Override
                    public void windowClosing(java.awt.event.WindowEvent e) {
                        System.exit(0);
                    }
                });
                dialog.setVisible(true);
            }
        });
    }
}
